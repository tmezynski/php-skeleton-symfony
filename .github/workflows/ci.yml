name: CI

on: [ push, pull_request ]

jobs:
    build:
        runs-on: ubuntu-latest
        env:
            APP_ENV: test
        steps:
            -   name: Branch checkout
                uses: actions/checkout@v4

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'

            -   name: Load .env
                uses: aarcangeli/load-dotenv@v1.0.0
                with:
                    filenames: |
                        .env
                        .env.${{ env.APP_ENV }}

            -   name: Cache composer dependencies
                uses: actions/cache@v3
                with:
                    path: vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            -   name: Cache symfony
                uses: actions/cache@v3
                with:
                    path: var/cache/test
                    key: ${{ runner.os }}-symfony-${{ github.run_id }}

            -   name: Setup project
                run: |
                    composer install --optimize-autoloader --no-scripts --no-progress --quiet
                    bin/console cache:warmup

    php-stan:
        runs-on: ubuntu-latest
        needs: build
        env:
            APP_ENV: test
        steps:
            -   name: Branch checkout
                uses: actions/checkout@v4

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'

            -   name: Load .env
                uses: aarcangeli/load-dotenv@v1.0.0
                with:
                    filenames: |
                        .env
                        .env.${{ env.APP_ENV }}

            -   name: Cache composer dependencies
                uses: actions/cache@v3
                with:
                    path: vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            -   name: Cache symfony
                uses: actions/cache@v3
                with:
                    path: var/cache
                    key: ${{ runner.os }}-cache-${{ github.run_id }}

            -   name: Run php stan
                run: composer test:php-stan

    cs-fixer:
        runs-on: ubuntu-latest
        needs: build
        env:
            APP_ENV: test
        steps:
            -   name: Branch checkout
                uses: actions/checkout@v4

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'

            -   name: Load .env
                uses: aarcangeli/load-dotenv@v1.0.0
                with:
                    filenames: |
                        .env
                        .env.${{ env.APP_ENV }}

            -   name: Cache composer dependencies
                uses: actions/cache@v3
                with:
                    path: vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            -   name: Cache symfony
                uses: actions/cache@v3
                with:
                    path: var/cache
                    key: ${{ runner.os }}-cache-${{ github.run_id }}

            -   name: Run cs fixer
                run: composer test:cs-fixer

    deptrac:
        runs-on: ubuntu-latest
        needs: build
        env:
            APP_ENV: test
        steps:
            -   name: Branch checkout
                uses: actions/checkout@v4

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'

            -   name: Load .env
                uses: aarcangeli/load-dotenv@v1.0.0
                with:
                    filenames: |
                        .env
                        .env.${{ env.APP_ENV }}

            -   name: Cache composer dependencies
                uses: actions/cache@v3
                with:
                    path: vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            -   name: Cache symfony
                uses: actions/cache@v3
                with:
                    path: var/cache
                    key: ${{ runner.os }}-cache-${{ github.run_id }}

            -   name: Run deptrac
                run: composer test:deptrac

    unit:
        runs-on: ubuntu-latest
        needs: [ php-stan, cs-fixer, deptrac ]
        env:
            APP_ENV: test
        steps:
            -   name: Branch checkout
                uses: actions/checkout@v4

            -   name: Load .env
                uses: aarcangeli/load-dotenv@v1.0.0
                with:
                    filenames: |
                        .env
                        .env.${{ env.APP_ENV }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'

            -   name: Cache composer dependencies
                uses: actions/cache@v3
                with:
                    path: vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            -   name: Cache symfony
                uses: actions/cache@v3
                with:
                    path: var/cache
                    key: ${{ runner.os }}-cache-${{ github.run_id }}

            -   name: Setup project
                run: composer migrations

            -   name: Unit tests
                run: composer test:unit

    integration:
        runs-on: ubuntu-latest
        needs: [ php-stan, cs-fixer, deptrac ]
        services:
            postgres:
                image: postgres
                env:
                    POSTGRES_DB: skeleton_test
                    POSTGRES_USER: user
                    POSTGRES_PASSWORD: password
                options: >-
                    --health-cmd pg_isready
                    --health-interval 3s
                    --health-timeout 5s
                    --health-retries 20
                ports:
                    - 5432:5432
        env:
            APP_ENV: test
            DB_HOST: localhost
        steps:
            -   name: Branch checkout
                uses: actions/checkout@v4

            -   name: Load .env
                uses: aarcangeli/load-dotenv@v1.0.0
                with:
                    filenames: |
                        .env
                        .env.${{ env.APP_ENV }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'

            -   name: Cache composer dependencies
                uses: actions/cache@v3
                with:
                    path: vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            -   name: Cache symfony
                uses: actions/cache@v3
                with:
                    path: var/cache
                    key: ${{ runner.os }}-cache-${{ github.run_id }}

            -   name: Setup project
                run: composer migrations

            -   name: Integration tests
                run: composer test:integration

    behat:
        runs-on: ubuntu-latest
        needs: [ php-stan, cs-fixer, deptrac ]
        services:
            postgres:
                image: postgres
                env:
                    POSTGRES_DB: skeleton_test
                    POSTGRES_USER: user
                    POSTGRES_PASSWORD: password
                options: >-
                    --health-cmd pg_isready
                    --health-interval 3s
                    --health-timeout 5s
                    --health-retries 20
                ports:
                    - 5432:5432
        env:
            APP_ENV: test
            DB_HOST: localhost
        steps:
            -   name: Branch checkout
                uses: actions/checkout@v4

            -   name: Load .env
                uses: aarcangeli/load-dotenv@v1.0.0
                with:
                    filenames: |
                        .env
                        .env.${{ env.APP_ENV }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'

            -   name: Cache composer dependencies
                uses: actions/cache@v3
                with:
                    path: vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            -   name: Cache symfony
                uses: actions/cache@v3
                with:
                    path: var/cache
                    key: ${{ runner.os }}-cache-${{ github.run_id }}

            -   name: Setup project
                run: composer migrations

            -   name: Behat tests
                run: composer test:behat
